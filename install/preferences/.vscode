#!/usr/bin/env bash

###############################################################################
# Visual Studio Code
###############################################################################

# If a command fails, bash exits instead of continuing with the rest of the script
set -o errexit

# Get the dotfiles directory (go up two levels from install/preferences/)
if [[ -z "$DOTFILES_DIR" ]]; then
    SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
    DOTFILES_DIR="$(cd "$SCRIPT_DIR/../.." && pwd)"
fi

settingsSource=$DOTFILES_DIR/applications/vscode/settings.json
keybindingsSource=$DOTFILES_DIR/applications/vscode/keybindings.json
vsiconsSource=$DOTFILES_DIR/applications/vscode/vsicons.settings.json
projectsSource=$DOTFILES_DIR/applications/vscode/projects.json
snippetsSource=$DOTFILES_DIR/applications/vscode/snippets/

vsCodeUser=$HOME/Library/Application\ Support/Code/User

settingsTarget=$vsCodeUser/settings.json
keybindingsTarget=$vsCodeUser/keybindings.json
vsiconsTarget=$vsCodeUser/vsicons.settings.json
projectsTarget=$vsCodeUser/projects.json
snippetsTarget=$vsCodeUser/snippets

printf "VS Code: Linking config files\\n"

# Create VS Code User directory if it doesn't exist
mkdir -p "$vsCodeUser"

echo "VS Code: Linking settings.json"
if [[ -f "$settingsSource" ]] ; then
    [[ -f "$settingsTarget" ]] && rm -rf "$settingsTarget"
    ln -s "$settingsSource" "$settingsTarget"
fi

echo "VS Code: Linking keybindings.json"
if [[ -f "$keybindingsSource" ]] ; then
    [[ -f "$keybindingsTarget" ]] && rm -rf "$keybindingsTarget"
    ln -s "$keybindingsSource" "$keybindingsTarget"
fi

echo "VS Code: Linking icons"
if [[ -f "$vsiconsSource" ]] ; then
    [[ -f "$vsiconsTarget" ]] && rm -rf "$vsiconsTarget"
    ln -s "$vsiconsSource" "$vsiconsTarget"
fi

printf "VS Code: Linking snippets\\n"
if [[ -d "$snippetsSource" ]] ; then
    echo "VS Code: Remove snippets directory if already exists"
    [[ -d "$snippetsTarget" ]] && rm -rf "$snippetsTarget"
    ln -s "$snippetsSource" "$snippetsTarget"
fi

echo "VS Code: Installing extensions"
xargs -L1 code --install-extension < "$DOTFILES_DIR/applications/vscode/.vscode_extensions"

printf "VS Code: Linking projects list from the Projects extension\\n"
if [[ -f "$projectsSource" ]] ; then
    [[ -f "$projectsTarget" ]] && rm -rf "$projectsTarget"
    ln -s "$projectsSource" "$projectsTarget"
fi
